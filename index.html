<!-- @format -->

<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>播放頁</title>
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <!-- //google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet" />

    <!-- @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap'); -->
    <style>
      /* player */

      #leo_player {
        position: fixed;
        width: 100%;
        bottom: 0;
        padding: 7px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #262626;
      }
      #leo_player button {
        background: none;
        border: none;
        cursor: pointer;
      }

      .player_left {
        width: 30%;
        display: flex;
      }
      .player_left_text {
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .player_left_text p {
        color: white;
      }
      .player_left_photo {
        max-width: 60px;
        margin-right: 10px;
      }
      .player_left_photo img {
        height: 100%;
        object-fit: cover;
      }
      .player_mid {
        width: 40%;
        display: flex;
        justify-content: center;
      }
      .player_mid ul {
        display: flex;
      }
      .player_right {
        width: 30%;
        display: flex;
        justify-content: flex-end;
      }
      .player_right ul {
        display: flex;
      }
      #duration {
        cursor: pointer;
        bottom: 100%;
        position: absolute;
        left: 0;
        height: 5px;
        width: 100%;
        background-color: rgb(104, 104, 104);
      }

      #now_duration {
        background-color: #24ac64;
        height: 5px;
      }
      .songtime {
        padding: 0 3px;
        font-size: 14px;
        position: absolute;
        width: 100%;
        bottom: calc(100% + 9px);
        left: 0;
        display: flex;
        justify-content: space-between;
      }

      /* playpage */
      .leo_container {
        max-width: 1140px;
        margin: auto;
        position: relative;
      }
      .playpage_main {
        display: flex;
      }
      .playpage_main section {
        position: relative;
        width: 50%;
      }
      .playpage_left {
        position: relative;
      }
      .playpage_right {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .playpage_right .lyric_wrap {
        max-height: 70%;
        overflow: hidden;
      }
      .playpage_right .lyric_wrap #lyric li {
        text-align: center;
      }
      .playpage_wave {
        position: absolute;
        width: 100%;
        bottom: 60px;
      }
      /* 左側聲波 */
      .music_flow {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: -99;
      }
      /* 歌詞 */
      .lyric_wrap {
        padding: 50% 0;
      }
      #lyric {
        font-size: 20px;
        font-family: "Roboto", sans-serif;
        font-weight: 100;
        color: #938686;
        transition: transform 0.1s linear;
      }
      #lyric li {
        transition: font-size 0.1s linear;
        line-height: 30px;
        padding: 10px 0;
      }
      #lyric .highlight {
        font-size: 30px;
        font-weight: 500;
        color: black;
      }

      /* 不用 */
      nav {
        height: 70px;
        background-color: black;
        color: white;
      }
      /* * {
        border: black 1px solid !important;
      } */
    </style>
  </head>

  <body>
    <nav>不是我做的nav</nav>
    <div class="leo_container">
      <div class="playpage_main">
        <section class="playpage_main playpage_left">
          <main>
            <div class="player">
              <div class="record">
                <div class="label"></div>
                <div class="spindle"></div>
              </div>
              <div class="arm-container">
                <div class="knob weight bottom"></div>
                <div class="arm"></div>
                <div class="knob weight top">
                  <button class="play"></button>
                </div>
              </div>
              <div class="speaker">
                <div class="hole"></div>
                <div class="hole"></div>
                <div class="hole"></div>
                <div class="hole"></div>
                <div class="hole"></div>
                <div class="hole"></div>
                <div class="hole"></div>
                <div class="hole"></div>
              </div>
              <div class="knob volume bottom">
                <div class="down"></div>
                <div class="up"></div>
              </div>
              <div class="knob volume top"></div>
            </div>
          </main>
          <div class="music_flow"><canvas id="output" height="650" width="650"></canvas></div>
        </section>
        <section class="playpage_main playpage_right">
          <div class="lyric_wrap">
            <ul id="lyric"></ul>
          </div>
        </section>
      </div>
    </div>
    <div class="playpage_wave">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(217, 220, 223,0.7)" />
          <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(217, 220, 223,0.5)" />
          <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(217, 220, 223,0.3)" />
          <use xlink:href="#gentle-wave" x="48" y="7" fill="rgb(217, 220, 223)" />
        </g>
      </svg>
    </div>
    <div id="leo_player">
      <div class="songtime">
        <div id="nowTime"></div>
        <div id="allTime">3:31</div>
      </div>
      <div id="duration">
        <div id="now_duration"></div>
      </div>
      <!-- <div class="duration_bar"><input type="range" /></div> -->
      <div class="player_left">
        <div class="player_left_photo"><img src="./image/62d669741d787b91e6fc027ec9842a2d.jpeg" alt="" /></div>
        <div class="player_left_text">
          <h3>Lost cause</h3>
          <p>Billie Eilish</p>
        </div>
      </div>
      <div class="player_mid">
        <ul>
          <li>
            <button><img src="./image/playericon/shuffle.svg" alt="" /></button>
          </li>
          <li>
            <button><img src="./image/playericon/next track-1.svg" alt="" /></button>
          </li>
          <li>
            <button id="play"><img src="./image/playericon/play.svg" alt="" /></button>
          </li>
          <li>
            <button id="stop"><img src="./image/playericon/pause.svg" alt="" /></button>
          </li>
          <li>
            <button><img src="./image/playericon/next track.svg" alt="" /></button>
          </li>

          <li>
            <button><img src="./image/playericon/cycle arrows.svg" alt="" /></button>
          </li>
        </ul>
      </div>
      <div class="player_right">
        <ul>
          <li>
            <button><img src="./image/playericon/sound.svg" alt="" /></button>
          </li>
          <li>
            <button><img src="./image/playericon/Playlist.svg" alt="" /></button>
          </li>
        </ul>
      </div>
    </div>

    <audio id="music" src="">
      <track kind="subtitles" label="English" src="./lyrics/lost cause.vtt" default />
    </audio>

    <!-- 音樂聲波 -->
    <script src="https://cdn.jsdelivr.net/gh/foobar404/wave.js/dist/bundle.iife.js"></script>

    <script src="./js/main.js"></script>
    <script>
      let music = document.getElementById("music");
      music.src = "./music/Billie Eilish - Lost Cause (Official Music Video).mp3";

      let playButton = document.getElementById("play");
      let stopButton = document.getElementById("stop");
      let durationBar = document.getElementById("now_duration");
      let durationBarWrap = document.getElementById("duration");
      let musicNowTime = document.getElementById("nowTime");
      let lyricWrap = document.getElementById("lyric");

      playButton.addEventListener("click", playMusic); //點擊播放
      stopButton.addEventListener("click", stopMusic); //點擊暫停
      music.addEventListener("timeupdate", whenMusicPlaying); //音樂播放就會一直觸發
      durationBarWrap.addEventListener("click", clickDurationBar); //點擊播放吧

      function playMusic() {
        //播放音樂
        music.play();
        recordRotate();
      }

      function stopMusic() {
        //暫停音樂
        music.pause();
        recordRotateStop();
      }

      function whenMusicPlaying() {
        //音樂播放就會一直觸發
        timeDurationBar();
        currentTime();
        highlightLyric();
      }
      function recordRotate() {
        //唱片轉動
        document.querySelector(".record").classList.add("recordRotate");
      }
      function recordRotateStop() {
        //唱片停止轉動
        document.querySelector(".record").classList.remove("recordRotate");
      }

      function currentTime() {
        //顯示現在時間文字
        let s = music.currentTime;
        musicNowTime.innerText = `${seceondToMinutes(s)[0]}:${seceondToMinutes(s)[1]}`;
      }

      function seceondToMinutes(s) {
        //秒鐘換成分鐘
        let minutes = "0" + Math.floor(s / 60);
        let second = Math.floor(s % 60);
        if (second < 10) {
          second = "0" + Math.floor(s % 60);
        } else {
          second = Math.floor(s % 60);
        }
        return [minutes, second];
      }
      function timeDurationBar() {
        //bar伸縮
        if (!music.duration) {
          durationBar.style.width = "0%";
          return;
        }
        durationBar.style.width = (music.currentTime / music.duration) * 100 + "%";
      }

      function clickDurationBar(e) {
        //bar點擊後更改時間
        let userClick = e.offsetX / durationBarWrap.offsetWidth; //用戶點擊的bar的位置（尚未乘上100%）
        durationBar.style.width = userClick * 100 + "%";
        music.currentTime = userClick * music.duration;
      }

      let lyricsData;
      let lyrics = [];
      //取得歌詞
      fetch("./lyrics/lost%20cause.vtt", {
        method: "get",
      })
        .then(function (response) {
          return response.text();
        })
        .then(function (result) {
          lyricsData = result;
          parseToLyrics(); //轉換歌詞成物件
          createLyrics(); //生成歌詞
          setFirstLyricAnimate(); //設定歌詞的初始動態樣式
        })
        .catch(function (err) {
          console.log(err);
        });

      function parseToLyrics() {
        let lyricsArray = lyricsData.split("\n\n");
        let index = 0;
        lyrics = lyricsArray.map(function (item) {
          let parts = item.split("\n");
          let timeSplit = parts[0].split(" ");
          return {
            index: index++,
            timeStart: vttTimeToSecond(timeSplit[0]),
            timeEnd: vttTimeToSecond(timeSplit[2]),
            text: parts[1],
          };
        });
        console.log(lyrics);
      }

      function createLyrics() {
        lyrics.forEach((element) => {
          lyricWrap.innerHTML += `<li id="lyrics${element["index"]}">${element["text"]}</li>`;
        });
      }

      function vttTimeToSecond(time) {
        //將vtt時間轉換為秒鐘
        let second = time.slice(6, 8);
        let minutes = time.slice(3, 5);
        return minutes * 60 + second * 1;
      }

      function highlightLyric() {
        //抓到現在是哪句歌詞
        let s = music.currentTime;
        let nowLyrics;
        nowLyrics = lyrics.filter(function (element) {
          return element["timeStart"] < s && element["timeEnd"] > s;
        });
        console.log(nowLyrics);
        //highlight前端頁面當前歌詞div
        if (nowLyrics[0]) {
          let allLyric = document.querySelectorAll("ul li");
          for (let i = 0; i < allLyric.length; i++) {
            allLyric[i].classList.remove("highlight");
          }
          document.querySelector("#lyrics" + nowLyrics[0]["index"]).classList.add("highlight");
          setLyricAnimate(nowLyrics[0].index);
        }
      }
      window.addEventListener("load", whenPageLoad); //載入時執行
      window.addEventListener("resize", setPlaypageMainHeight); //視窗變化時執行
      function whenPageLoad() {
        //載入時執行
        setPlaypageMainHeight(); //設定中間內容的高度
      }
      function setPlaypageMainHeight() {
        //設定中間內容的高度
        //網頁視窗高度-nav-播放器
        let height = window.innerHeight - document.querySelector("nav").offsetHeight - document.querySelector("#leo_player").offsetHeight;
        document.querySelector(".playpage_main").style.height = height + "px";
      }

      function setFirstLyricAnimate() {
        //設定歌詞的初始動態樣式
        document.getElementById("lyrics0").classList.add("highlight");
        let highlighHigh = document.querySelector("#lyric .highlight").offsetHeight;
        document.querySelector("#lyric").setAttribute("style", `transform:translateY(-${highlighHigh / 2}px)`);
      }

      function setLyricAnimate(nowLyric) {
        let highlighHigh = document.querySelector("#lyric .highlight").offsetHeight;
        let lyricHeight = document.querySelector("#lyric li").offsetHeight;
        document.querySelector("#lyric").setAttribute("style", `transform:translateY(-${highlighHigh / 2 + nowLyric * lyricHeight}px)`);
      }
    </script>
    <script>
      let wave = new Wave();
      wave.fromElement("music", "output", { type: "flower", colors: ["#E88239"] });
    </script>
  </body>
</html>
