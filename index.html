<!-- @format -->

<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <style>
      /* player */
      #player {
        position: fixed;
        width: 100%;
        bottom: 0;
        padding: 7px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #262626;
      }

      .player_left {
        display: flex;
      }
      .player_left_text {
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .player_left_photo {
        max-width: 60px;
        margin-right: 10px;
      }
      .player_left_photo img {
        height: 100%;
        object-fit: cover;
      }
      .player_mid ul {
        display: flex;
      }
      .player_right ul {
        display: flex;
      }
      #duration {
        cursor: pointer;
        bottom: 100%;
        position: absolute;
        left: 0;
        height: 5px;
        width: 100%;
        background-color: #262626 (189, 186, 186);
      }

      #now_duration {
        background-color: rgb(81, 218, 129);
        height: 5px;
      }
      .songtime {
        font-size: 14px;
        position: absolute;
        width: 100%;
        bottom: calc(100% + 9px);
        left: 0;
        display: flex;
        justify-content: space-between;
      }
      /* 不用 */
      nav {
        height: 70px;
        background-color: black;
        color: white;
      }
    </style>
  </head>

  <body>
    <nav>不是我做的nav</nav>

    <div id="player">
      <div class="songtime">
        <div id="nowTime"></div>
        <div id="allTime">3:31</div>
      </div>
      <div id="duration">
        <div id="now_duration"></div>
      </div>
      <!-- <div class="duration_bar"><input type="range" /></div> -->
      <div class="player_left">
        <div class="player_left_photo"><img src="./image/62d669741d787b91e6fc027ec9842a2d.jpeg" alt="" /></div>
        <div class="player_left_text">
          <h3>Lost cause</h3>
          <p>Billie Eilish</p>
        </div>
      </div>
      <div class="player_mid">
        <ul>
          <li><button>隨機</button></li>
          <li><button>上一首</button></li>
          <li><button id="play">播放</button></li>
          <li><button id="stop">暫停</button></li>
          <li><button>下一首</button></li>
          <li><button>重複</button></li>
        </ul>
      </div>
      <div class="player_right">
        <ul>
          <li><button>音量</button></li>
          <li><button>播放列表</button></li>
        </ul>
      </div>
    </div>
    <audio id="music" src="">
      <track kind="subtitles" label="English" src="./lyrics/lost cause.vtt" default />
    </audio>

    <ul id="lyric_wrap"></ul>

    <script src="./js/main.js"></script>
    <script>
      let music = document.getElementById("music");
      music.src = "./music/Billie Eilish - Lost Cause (Official Music Video).mp3";

      let playButton = document.getElementById("play");
      let stopButton = document.getElementById("stop");
      let durationBar = document.getElementById("now_duration");
      let durationBarWrap = document.getElementById("duration");
      let musicNowTime = document.getElementById("nowTime");
      let lyricWrap = document.getElementById("lyric_wrap");

      playButton.addEventListener("click", playMusic); //點擊播放
      stopButton.addEventListener("click", stopMusic); //點擊暫停
      music.addEventListener("timeupdate", whenMusicPlaying); //音樂播放就會一直觸發
      durationBarWrap.addEventListener("click", clickDurationBar); //點擊播放吧

      function playMusic() {
        //播放音樂
        music.play();
      }

      function stopMusic() {
        //暫停音樂
        music.pause();
      }

      function whenMusicPlaying() {
        //音樂播放就會一直觸發
        timeDurationBar();
        currentTime();
        highlightLyric();
      }

      function currentTime() {
        //顯示現在時間文字
        let s = music.currentTime;
        musicNowTime.innerText = `${seceondToMinutes(s)[0]}:${seceondToMinutes(s)[1]}`;
      }

      function seceondToMinutes(s) {
        //秒鐘換成分鐘
        let minutes = "0" + Math.floor(s / 60);
        let second = Math.floor(s % 60);
        if (second < 10) {
          second = "0" + Math.floor(s % 60);
        } else {
          second = Math.floor(s % 60);
        }
        return [minutes, second];
      }

      function timeDurationBar() {
        //bar伸縮
        if (!music.duration) {
          durationBar.style.width = "0%";
          return;
        }
        durationBar.style.width = (music.currentTime / music.duration) * 100 + "%";
      }

      function clickDurationBar(e) {
        //bar點擊後更改時間
        let userClick = e.offsetX / durationBarWrap.offsetWidth; //用戶點擊的bar的位置（尚未乘上100%）
        durationBar.style.width = userClick * 100 + "%";
        music.currentTime = userClick * music.duration;
      }

      let lyricsData;
      let lyrics = [];
      //取得歌詞
      fetch("./lyrics/lost%20cause.vtt", {
        method: "get",
      })
        .then(function (response) {
          return response.text();
        })
        .then(function (result) {
          lyricsData = result;
          parseToLyrics();
          createLyrics();
        })
        .catch(function (err) {
          console.log(err);
        });

      function parseToLyrics() {
        let lyricsArray = lyricsData.split("\n\n");
        let index = 0;
        lyrics = lyricsArray.map(function (item) {
          let parts = item.split("\n");
          let timeSplit = parts[0].split(" ");
          return {
            index: index++,
            timeStart: vttTimeToSecond(timeSplit[0]),
            timeEnd: vttTimeToSecond(timeSplit[2]),
            text: parts[1],
          };
        });
        console.log(lyrics);
      }

      function createLyrics() {
        lyrics.forEach((element) => {
          lyricWrap.innerHTML += `<li id="lyrics${element["index"]}">${element["text"]}</li>`;
        });
      }

      function vttTimeToSecond(time) {
        //將vtt時間轉換為秒鐘
        let second = time.slice(6, 8);
        let minutes = time.slice(3, 5);
        return minutes * 60 + second * 1;
      }

      function highlightLyric() {
        //抓到現在是哪句歌詞
        let s = music.currentTime;
        let nowLyrics;
        nowLyrics = lyrics.filter(function (element) {
          return element["timeStart"] < s && element["timeEnd"] > s;
        });
        //highlight前端頁面當前歌詞div
        if (nowLyrics[0]) {
          let allLyric = document.querySelectorAll("ul li");
          for (let i = 0; i < allLyric.length; i++) {
            allLyric[i].style.background = "none";
          }
          document.querySelector("#lyrics" + nowLyrics[0]["index"]).style.background = "rgb(169, 168, 168)";
        }
      }
    </script>
  </body>
</html>
